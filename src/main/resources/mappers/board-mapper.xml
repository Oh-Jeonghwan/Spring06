<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd"><!-- xml 파일의 유효성 체크를 위한 부분 -->
  <mapper namespace="board">
  	 
  	 <!-- 
  	 	* 정적 바인딩과 동적 바인딩
  	 	(참고로 자바에서의 동적바인딩 개념과 헷갈리면 큰일남)
  	 	-기존 방식에서 검색 기능 구현할 때는 조건에 따른 쿼리문들을 일일이 다 만들어야 했음
  	 	-mybatis 에서는 정적버인딩 개념을 이용해서 한 개의 쿼리문으로 여러 조건을 받을 수 있음
  	 	
  	 	${키값}: 정적 바인딩 (있는 그대로의 값을 그냥 삽입)
  	 			쿼리가 수행될 때 ${키값} 자리에 기존의 값이 하드코딩된다.
  	 			column = 값 (Statement)
  	 	#{키값}: 동적 바인딩 (자로형에 맞춰서 맞춤형으로 삽입)
  	 			쿼리가 수행될 때 #{키값} 자리에 값이 바인딩된다.
  	 			column =? (기존의 위치홀더에 값이 들어가는 개념 => PreparedStatement)
  	 	=> 그래서 보통은 이런 식으로 쓰인다.
  	 	      컬럼명에도 구멍을 뚫어야 할 경우
  	 	      컬렁명이 들어가야 할 자리에는 ${키값}, 리터럴이 들어가야 할 자리에는 #{키값} 이 쓰임
  	 	=> 성능상 보면 동적바인딩이 더 유리는 하겠으나
  	 		상황에 따라 컬럼명이나 테이블 명을 메꿔야하 하는 상황이라면 정적바인딩이 필요
  	  -->
  	
  	  <select id="unionList" resultType="board" parameterType="map">
		SELECT *	 
		FROM (SELECT ROWNUM RNUM, A.*	  	
			  FROM (SELECT *
				  	FROM BOARD
			  		WHERE STATUS='Y'
				  	<!-- 만약에 type 이랑 keyword에 둘다 값이 있다면 -->
				  <if test="type != null and keyword != null">
				  	AND ${type} LIKE '%'||#{keyword}||'%'
				  </if>
				  	ORDER BY CREATE_DATE DESC) A)
		WHERE RNUM BETWEEN #{pageStart} AND #{perPageNum}
  	  </select>
  	  
  	  <!-- 게시글 작성용 쿼리문 -->
  	  <insert id="write" parameterType="board">
  	  	INSERT INTO BOARD (BOARD_NO
  	  					 , BOARD_HEAD
  	  					 , BOARD_TITLE
  	  					 , BOARD_WRITER
  	  					 , BOARD_CONTENT
  	  					 , STATUS)
  	  	VALUES (SEQ_BNO.NEXTVAL
  	  	      , #{boardHead}
  	  	      , #{boardTitle}
  	  	      , #{boardWriter}
  	  	      , #{boardContent}
  	  	      , DEFAULT)
  	  </insert>
  	  
  	  <!-- 게시글 상세조회 쿼리문 -->
  	  <!-- 1. 조회수 증가 -->
  	  <update id="increaseCount" parameterType="int">
  	  	UPDATE BOARD
  	  	   SET BOARD_READ = BOARD_READ + 1
  	  	 WHERE BOARD_NO = #{boardNo}
  	  </update>
  	  
  	  <!-- 2. 게시글 상세조회 -->
  	  <select id="detailView" resultType="board" parameterType="int">
		SELECT *
		FROM BOARD
		WHERE BOARD_NO = #{boardNo} 	  
  	  </select>
  	  
  	  <select id="totalCount" resultType="int">
  	  	SELECT COUNT(*)
  	  	FROM BOARD
  	  	WHERE STATUS='Y'
  	  	<if test="type != null and keyword != null">
		  AND ${type} LIKE '%'||#{keyword}||'%'
		</if>
  	  </select>
  	  
  	  <insert id="insertBReply" parameterType="boardreply">
  	  	INSERT INTO BOARD_REPLY(REPLY_NO
  	  						  , REPLY_CONTENT
  	  						  , REF_BNO
  	  						  , REFLY_WRITER
							  , CREATE_DATE
							  , STATUS)
		VALUES(SEQ_BRNO.NEXTVAL
			 , #{replyContent}
			 , #{refBno}
			 , #{reflyWriter}
			 , DEFAULT
			 , DEFAULT)
  	  </insert>
  	  
  	  <select id="brList" parameterType="int" resultType="boardreply">
  	  	SELECT *
		FROM BOARD_REPLY
		WHERE REF_BNO=#{bno}
		AND STATUS='Y'
  	  </select>
  	  
  	  <select id="selectdBoard" parameterType="int" resultType="board">
  	   SELECT *
  	   FROM BOARD
  	   WHERE BOARD_NO = #{bno}
  	  </select>
  	  
  	  <update id="boardUpdate" parameterType="board">
  	  	UPDATE BOARD
  	  	   SET BOARD_TITLE = #{boardTitle},
  	  	   	   BOARD_CONTENT=#{boardContent},
  	  	   	   BOARD_HEAD=#{boardHead}
  	  	 WHERE BOARD_NO = #{boardNo}
  	  </update>
  	  
  	  <update id="bDelete" parameterType="int">
  	  	UPDATE BOARD
  	  	   SET STATUS='N'
  	  	 WHERE BOARD_NO = #{bno}
  	  </update>
  	  
  	  <select id="likeCheck" parameterType="map" resultType="int">
  	  	SELECT COUNT(*)
		FROM LIKABLE
		WHERE LIKE_MEM=#{memId}
		AND REF_BNO=#{bno}
		AND STATUS='Y'
  	  </select>
  	  
  	  <select id="likeCount" parameterType="int" resultType="int">
  	  	SELECT COUNT(*)
		FROM LIKABLE
		WHERE REF_BNO=#{bno}
		AND STATUS='Y'
  	  </select>
  	  
  	  <insert id="likeInsert" parameterType="map">
  	  	INSERT INTO LIKABLE
		VALUES(SEQ_LIKE.NEXTVAL
     		 , #{memId}
     		 , #{bno}
     		 , DEFAULT)
  	  </insert>
  	  
  	  <update id="likeUpdate" parameterType="map">
  	  	UPDATE LIKABLE
  	  	SET STATUS='N'
  	  	WHERE LIKE_MEM=#{memId}
  	  	AND REF_BNO=#{bno}
  	  </update>
  </mapper>